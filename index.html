<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>CDQ Screener</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" media="screen" href="styled/main.css" />
  <script src="elm.js"></script>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
</head>
<body>
  <div id="elm"></div>
  <script>
  var app = Elm.Main.init({
    node: document.getElementById('elm'),
  });
  /*
  const mockPairJSON = `{
    "Symbol":"ETHBTC",
    "Exchange":"BINANCE",
    "HighVolume24":"164625.909",
    "Bid":{"current":"0.033634","prev":"0.033671"},
    "Ask":{"current":"0.033643","prev":"0.033672"},
    "Low":{"current":"0.033531","prev":"0.033531"},
    "High":{"current":"0.034371","prev":"0.034371"},
    "Volume24":{"current":"159306.81","prev":"161977.811"},
    "MarketCup":{"current":"3.31153248592E9","prev":"0.0"},
    "MarketVol24":{"current":"1.2787931053E10","prev":"0.0"},
    "MarketHistory":{"sell":"26700.74200000019","buy":"26006.495999999803"},
    "InterestRatioNow":{"sell":"96","buy":"4"},
    "BaseVolume":{"currentDay":"5397.80119079","prevDay":"5489.05795146","twoPrevDay":"0.0"}
  }`

  const mockPairs = {
    BITTREX: Array.from({length: 10}, (_, i) => "BTC-" + String.fromCharCode(65 + i, 65 + (i*2), 65 + (i*3) )),
    NOBIT: Array.from({length: 10}, (_, i) => "ETH-" + String.fromCharCode(65 + i, 65 + (i*2), 65 + (i*3) ))
  }


  let mockPair = JSON.parse(mockPairJSON)


  const incLastLetter = (s) => s.substr(0, s.length-1) + String.fromCharCode(s[s.length-1].charCodeAt() + 1)
  const multLastLetter = (s, x) => s.substr(0, s.length-1) + String.fromCharCode(s[s.length-1].charCodeAt() + x)
  
  const mockPairArray = Array.from({ length: 5 }, (_, i) => ({
    ...mockPair,
    Symbol: multLastLetter(mockPair.Symbol, i)
  }))
  


  mockPairArray.map(p => {
    app.ports.wsListenPairs.send(JSON.stringify(p))
  });
  */


  const endpoint = 'wss://coindaq.net:8080' // 'ws://142.93.47.26:1023' // 'wss://coindaq.net:8080'
  let socketAuth;
  let socketDefault;

  
  if (window.WebSocket) {
    socketAuth = new WebSocket(endpoint);
    socketAuth.onmessage = function (event) {
      
      app.ports.wsListenPairs.send(event.data)

      if (JSON.parse(event.data).Bid === undefined) {
        app.ports.wsListenUnsubcribePairs.send(event.data)
      }

      // console.log(event.data)
    }
    socketAuth.onopen = function (event) {
      console.log("Web Socket opened!");
    };
    socketAuth.onclose = function (event) {
      console.log("Web Socket closed.");
    };

    app.ports.toJs.subscribe((data) => {
      console.log('toJs.subscribe socketAuth', data)
      socketAuth.send(JSON.stringify(data))
      
    })
    


    socketDefault = new WebSocket(`${endpoint}/defaults`);
    socketDefault.onmessage = function (event) {
      
      app.ports.wsListenPairs.send(event.data)

      // console.log(event.data)
    }
    socketDefault.onopen = function (event) {
      console.log("Web Socket default opened!");
    };
    socketDefault.onclose = function (event) {
      console.log("Web Socket default closed.");
    };

    app.ports.toJs.subscribe((data) => {
    })

  } else {
    console.log("Your browser does not support Websockets. (Use Chrome)");
  }

</script>
</body>
</html>